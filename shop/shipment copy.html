<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Rental</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="shipping" class="tab-content hidden">
        <div class="max-w-10xl mx-auto bg-white shadow-md rounded-lg sm:p-6 py-6">
            <form id="checkoutForm" class="border w-72 px-2 sm:py-4 sm:px-2 sm:w-4/12 border-pink-600 flex flex-col justify-center mx-auto sm:mx-40 font-bold rounded">
                <p class="text-sm sm:text-xl font-bold my-2 text-black">Kindly enter your Information Details</p>
                
                <label class="text-sm mt-2 text-black">Recipient First Name:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="recipient_firstname" required>
                
                <label class="text-sm mt-2 text-black">Recipient Last Name:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="recipient_lastname" required>
                
                <label class="text-sm mt-2 text-black">Recipient Phone Number:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="recipient_phone" required>
                
                <label class="text-sm mt-2 text-black">Recipient Address:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="address" required>
                
                <label class="text-sm mt-2 text-black">Country:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="country" required>
                
                <label class="text-sm mt-2 text-black">City:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="city" required>
                
                <label class="text-sm mt-2 text-black">State:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="state" required>
                
                <label class="text-sm mt-2 text-black">Zip Code:</label>
                <input class="border-2 border-red-200 w-64 sm:w-96 p-1 my-1 rounded-lg outline-none" type="text" id="zip_code" required>
                
                <button type="submit" class="my-5 w-64 bg-red-500 text-white sm:w-96 mx-auto p-1 my-1 rounded-lg outline-none">Submit Form</button>
            </form>
            <p id="message" class="text-red-600 text-center my-2 font-bold"></p>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("shipping").classList.remove("hidden");

    document.getElementById("checkoutForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        // ✅ 1. Get User ID from Local Storage
        const userId = parseInt(localStorage.getItem("user_id"), 10);
        if (!userId) {
            console.error("Error: User ID is missing in localStorage");
            document.getElementById("message").textContent = "Error: User ID is missing. Please log in.";
            return;
        }

        // ✅ 2. Get Order Data from Local Storage
        // const orderData = localStorage.getItem("order");
        // console.log("Order data from localStorage:", orderData); // Debugging log

        // if (!orderData) {
        //     document.getElementById("message").textContent = "Your cart is empty.";
        //     return;
        // }

        // let order;
        // try {
        //     order = JSON.parse(orderData);
        // } catch (error) {
        //     console.error("Error parsing order data:", error);
        //     document.getElementById("message").textContent = "Error retrieving cart data.";
        //     return;
        // }

        // if (!Array.isArray(order) || order.length === 0) {
        //     document.getElementById("message").textContent = "Your cart is empty.";
        //     return;
        // }

        // ✅ 3. Collect Shipment Information
        const shipment = {
            recipient_firstname: document.getElementById("recipient_firstname").value.trim(),
            recipient_lastname: document.getElementById("recipient_lastname").value.trim(),
            recipient_phone: document.getElementById("recipient_phone").value.trim(),
            address: document.getElementById("address").value.trim(),
            country: document.getElementById("country").value.trim(),
            city: document.getElementById("city").value.trim(),
            state: document.getElementById("state").value.trim(),
            zip_code: document.getElementById("zip_code").value.trim(),
        };

        if (Object.values(shipment).some(value => value === "")) {
            document.getElementById("message").textContent = "Please fill in all required fields.";
            return;
        }

        // ✅ 4. Calculate Total Price
        const totalPrice = order.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const paymentMethod = "Cash on Delivery";

        // ✅ 5. Prepare Data for Submission
        const requestData = {
            user_id: localStorage.getItem('user_id') ? parseInt(localStorage.getItem('user_id'), 10) : null,
            payment_method: paymentMethod,
            total_price: totalPrice,
            shipment: shipment,
            items: order.map(item => ({
                product_id: item.product_id,
                image: item.image,
                title: item.title,
                price: item.price,
                color: item.color,
                size: item.size,
                quantity: item.quantity,
                pick_up_date: item.pick_up_date,
                pick_up_time: item.pick_up_time,
                drop_off_date: item.drop_off_date,
                drop_off_time: item.drop_off_time,
            })),
        };

        console.log("Submitting data:", requestData); // Debugging log

        // ✅ 6. Send Data to PHP Backend
        try {
            const response = await fetch("http://localhost/mywebsite/function/checkout.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestData),
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Server response:", data);

            // ✅ 7. Handle Response
            if (data.success) {
                document.getElementById("message").textContent = "Your Information has been Saved!";
                localStorage.removeItem("order"); // ✅ Clear cart after checkout
                setTimeout(() => {
                    window.location.href = "/checkout/checkout";
                }, 1500);
            } else {
                document.getElementById("message").textContent = "Error: " + (data.message || "Something went wrong.");
            }
        } catch (error) {
            console.error("Error during submission:", error);
            document.getElementById("message").textContent = "Submission failed. Please try again.";
        }
    });
});
    </script>
</body>
</html>
