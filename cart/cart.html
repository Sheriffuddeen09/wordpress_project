<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>
    @media (min-width: 310px) {
    .width-des{
      width: 260px;
      text-align: justify;
      font-size: 12px;
      padding: 2px;
    }
}
@media (min-width: 768px) {
    .width-des{
      width: 320px;
      font-size: 13px;
      text-align: justify;
    }
  }
  
</style>
<body class="bg-gray-100">
    <div class="flex flex-col sm:flex-row gap-5 sm:mx-10">

        <div class="border border-pink-700 p-4 w-72 mx-auto mt-10 sm:w-96 mb-10 bg-white shadow-lg rounded-lg">
            <h2 class="text-pink-700 font-bold text-lg">Rental Duration</h2>
            <div id="rentalDuration"></div>
    
            <h2 class="text-pink-700 font-bold text-lg mt-4">Category</h2>
            <div id="categoryList"></div>
            <button id="toggleCategories" class="text-pink-700 mt-2">View All</button>
    
            <div class="w-full bg-pink-700 h-0.5 mt-1"></div>
    
            <h2 class="text-pink-700 font-bold text-lg mt-4">Location</h2>
            <input type="text" id="searchLocation" placeholder="Search location..." class="border p-2 w-full mb-2">
            <div id="locationList"></div>
            <button id="toggleLocations" class="text-pink-700 mt-2">View All</button>
    
            <div class="w-full bg-pink-700 h-0.5 mt-1"></div>
    
            <h2 class="text-pink-700 font-bold text-lg mt-4">Cart Totals</h2>
            <div class="flex justify-between">
                <span>Subtotal:</span>
                <span id="totalPrice">$0.00</span>
            </div>
            <div class="flex justify-between font-bold">
                <span>Total:</span>
                <span id="formattedTotalPrice">$0.00</span>
            </div>
    
            <div class="p-4 border border-gray-300 rounded mt-4">
                <h2 class="text-pink-700 font-bold text-lg">Payment Method</h2>
                <div class="flex justify-center gap-4 mt-2">
                    <img src="../cart/images/paypal.png" alt="PayPal" class="w-20 h-12 cursor-pointer">
                    <img src="../cart/images/googlepay.png" alt="Google Pay" class="w-16 h-12 cursor-pointer">
                    <img src="../cart/images/visa.png" alt="Visa" class="w-20 h-12 cursor-pointer">
                </div>
            </div>
    
            <button id="checkoutBtn" class="bg-pink-700 text-white w-full mt-4 p-2 rounded">
                Proceed to Checkout
            </button>
        </div>


        <div class="w-full sm:w-full mb-10 mx-auto p-5">
            <div id="loading" class="text-center hidden">Loading Cart...</div>
            <div id="cartContainer"></div>
            <p id="empty-cart" class="text-center font-bold text-xl my-32 flex justify-center gap-3 items-center hidden">
                No Cart to display
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                </svg>
            </p>
        </div>
        
    </div>
   
    
    <script>
       
        let globalCart = []; // Store fetched cart globally
        let selectedCategories = []; // Fix: Define this globally
        let selectedLocations = [];  // Fix: Define this globally
        let showAllCategories = false;
        let showAllLocations = false;


        async function fetchCart() {
    const userId = localStorage.getItem("user_id");
    try {
        document.getElementById("loading").style.display = "block";
        const response = await fetch(`http://localhost/mywebsite/function/cart.php?user_id=${userId}`);
        const data = await response.json();
        document.getElementById("loading").style.display = "none";

        if (data.success) {
            globalCart = data.cart; // Store fetched cart globally
            localStorage.setItem("cart", JSON.stringify(globalCart)); // ✅ Save cart in localStorage
            displayCart(globalCart);
            updateTotalPrice();
        } else {
            document.getElementById("cartContainer").innerHTML = "<p class='text-center font-bold text-xl my-32'>No Cart to display</p>";
            localStorage.removeItem("cart"); // ✅ Clear localStorage if cart is empty
        }
    } catch (error) {
        console.error("Error fetching cart:", error);
    }
}

function displayCart(cart) {
    const cartContainer = document.getElementById("cartContainer");
    cartContainer.innerHTML = "";

const cartImage = 'http://localhost/mywebsite/image/'
    
    cart.forEach(car => {
        const cartItem = document.createElement("div");
        cartItem.className = "flex gap-5 border border-pink-700 p-1 sm:p-5 flex-row flex-wrap";
        cartItem.innerHTML = `
            <div class="flex flex-col">
                <img src="${cartImage}${car.image}" alt="${car.title}" class="w-72 h-52" />
                <div class="inline-flex gap-6 flex-wrap hidden">
                    <div>
                        <p class="text-center font-bold">Pick up Date & Time</p>
                        <div class="border w-36 border-2 rounded-lg p-2 mx-auto border-pink-700 text-center">
                            <p>${car.pick_up_date}</p>
                            <p>${car.pick_up_time}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-center font-bold">Drop off Date & Time</p>
                        <div class="border w-36 border-2 rounded-lg p-2 mx-auto border-pink-700 text-center">
                            <p>${car.drop_off_date}</p>
                            <p>${car.drop_off_time}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col">
                <div class="flex flex-row justify-between items-center">
                    <p class="text-sm font-bold bg-[#7fffd4] sm:w-56 text-center p-1 rounded">${car.title}</p>
                    <button onclick="handleRemove(${car.cart_id})" class="size-10 cursor-pointer hover:bg-gray-200 px-2 py-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    </button>
                </div>
                <div class="inline-flex gap-3 items-center">
                    <p class='sm:w-52 w-48 my-2' style="font-size:13px">${car.location}</p>
                </div>
                <div class="inline-flex flex-wrap gap-5 sm:gap-0">
                    <p class="text-sm h-8 font-bold bg-[#7fffd4] text-center p-1 rounded w-20">$${car.price}</p>
                    <p class="width-des md:translate-x-0 lg:translate-x-10">${car.maintenance}</p>
                </div>
            </div>
        `;
        cartContainer.appendChild(cartItem);
    });
}

        const categories = ["Dogs", "Cats", "Pet Clothing", "Pet Carriers", "Dog & Cat Beds"];
        const locations = ["Houston", "San Francisco", "Seattle", "Florida", "Illinois", "New York", "Los Angeles", "Chicago", "Miami", "Dallas"];
        const rentalDurations = ["Per Hour", "Per Day"];


        const cart = [
            { category: "Dogs", location: "Houston", price: 20 },
            { category: "Cats", location: "New York", price: 15 },
            { category: "Pet Clothing", location: "Miami", price: 10 }
        ];

        
        function renderCategories() {
            const categoryList = document.getElementById("categoryList");
            categoryList.innerHTML = "";
            const visibleCategories = showAllCategories ? categories : categories.slice(0, 3);
            visibleCategories.forEach(category => {
                const label = document.createElement("label");
                label.className = "block flex items-center gap-2";
                label.innerHTML = `
                    <input type="checkbox" class="categoryCheckbox" value="${category}">
                    ${category}
                `;
                categoryList.appendChild(label);
            });
        }

        function renderLocations() {
            const locationList = document.getElementById("locationList");
            locationList.innerHTML = "";
            const visibleLocations = showAllLocations ? locations : locations.slice(0, 3);
            visibleLocations.forEach(location => {
                const label = document.createElement("label");
                label.className = "block";
                label.innerHTML = `
                    <input type="checkbox" class="locationCheckbox" value="${location}">
                    ${location}
                `;
                locationList.appendChild(label);
            });
        }

        function renderRentalDurations() {
            const rentalDurationDiv = document.getElementById("rentalDuration");
            rentalDurationDiv.innerHTML = "";
            rentalDurations.forEach(duration => {
                const label = document.createElement("label");
                label.className = "block";
                label.innerHTML = `
                    <input type="checkbox" class="rentalCheckbox" value="${duration}">
                    ${duration}
                `;
                rentalDurationDiv.appendChild(label);
            });
        }


function updateTotalPrice() {
    const filteredCart = globalCart.filter(item => 
        (selectedCategories.length === 0 || selectedCategories.includes(item.category)) &&
        (selectedLocations.length === 0 || selectedLocations.includes(item.location))
    );

    const totalPrice = filteredCart.reduce((acc, item) => acc + Number(item.price), 0);
    document.getElementById("totalPrice").textContent = `$${totalPrice.toFixed(2)}`;
    document.getElementById("formattedTotalPrice").textContent = `$${totalPrice.toFixed(2)}`;

    displayCart(filteredCart);
}

document.getElementById("toggleCategories").addEventListener("click", () => {
    showAllCategories = !showAllCategories;
    document.getElementById("toggleCategories").textContent = showAllCategories ? "View Less" : "View All";
    renderCategories();
});

document.getElementById("toggleLocations").addEventListener("click", () => {
    showAllLocations = !showAllLocations;
    document.getElementById("toggleLocations").textContent = showAllLocations ? "View Less" : "View All";
    renderLocations();
});

document.addEventListener("change", (event) => {
    if (event.target.classList.contains("categoryCheckbox")) {
        if (event.target.checked) {
            selectedCategories.push(event.target.value);
        } else {
            selectedCategories = selectedCategories.filter(c => c !== event.target.value);
        }
        updateTotalPrice();
    }

    if (event.target.classList.contains("locationCheckbox")) {
        if (event.target.checked) {
            selectedLocations.push(event.target.value);
        } else {
            selectedLocations = selectedLocations.filter(l => l !== event.target.value);
        }
        updateTotalPrice();
    }
});



        async function handleRemove(cartId) {
            const userId = localStorage.getItem("user_id");
            try {
                const response = await fetch(`http://localhost/mywebsite/function/removecart.php`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cart_id: cartId, user_id: userId })
                });
                const data = await response.json();
                if (data.success) {
                    fetchCart();
                } else {
                    console.error("Delete failed:", data.error);
                }
            } catch (error) {
                console.error("Error removing item:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
    if (typeof renderCategories === "function") renderCategories();
    if (typeof renderLocations === "function") renderLocations();
    if (typeof renderRentalDurations === "function") renderRentalDurations();
    fetchCart();
});

    </script>
</body>
</html>
